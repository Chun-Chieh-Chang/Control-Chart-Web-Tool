# 前端開發日誌 & 技術決策紀錄 (2026-01-10)

## 1. 概覽 (Overview)
本日主要開發重點在於整合 QIP 數據提取功能的同時，**嚴格維持既有的視覺風格與數據處理模式**。經歷了從舊版 Chart.js 到新版 ApexCharts (SVG) 的技術轉型，最終確立了「現代化技術堆疊 + 經典視覺呈現」的開發路線。

---

## 2. 需求變更與技術決策歷程 (Development Journey)

### 階段一：視覺還原 (Revert to Chart.js)
*   **需求**：用戶反映新版圖表視覺與舊版差異過大，希望完全還原。
*   **行動**：
    *   重新引入 `Chart.js` 庫。
    *   將圖表容器從 `<div>` 改回 `<canvas>`。
    *   從舊版代碼 (`cavity-analysis_old.js`) 移植繪圖配置，確保顏色、線條寬度、Cpk 紅綠燈邏輯與原版像素級一致。
*   **結果**：成功還原視覺，但技術架構較舊（Canvas based）。

### 階段二：技術升級 (Pivot to SVG / ApexCharts)
*   **需求**：用戶希望圖像格式為 **SVG**（以獲得更好的縮放清晰度），但**必須保留階段一的舊版視覺風格**。
*   **行動**：
    *   切換回 `ApexCharts` (SVG based)。
    *   **關鍵技術點**：不使用 ApexCharts 的默認樣式，而是將 Chart.js 的顏色代碼（Hex Codes）與邏輯「翻譯」給 ApexCharts 使用。
    *   移除 `Chart.js` 依賴以保持專案輕量。

---

## 3. 成功修訂與技術細節 (Successful Revisions)

### A. 圖表視覺標準 (Chart Visualization Standards)
為保持風格一致，後續開發請遵循以下配色標準（源自舊版 VBA/Chart.js）：

*   **Chart Type**: ApexCharts (SVG)
*   **Color Palette**:
    *   **Mean (X-Bar/Avg)**: `#3b82f6` (Blue-500)
    *   **Target**: `#10b981` (Emerald-500)
    *   **USL/LSL/Errors**: `#ef4444` (Red-500)
    *   **Range (Variation)**: `#8b5cf6` (Violet-500)
    *   **Cpk Limits**:
        *   < 1.0: `#ef4444` (Red)
        *   1.0 - 1.33: `#f59e0b` (Amber)
        *   > 1.33: `#10b981` (Emerald)

### B. 交互體驗優化 (Interaction Enhancements)
解決了 SVG 圖表縮放後難以復原的問題。

*   **功能**：雙擊圖表區域重置縮放 (Double-click to Reset Zoom)。
*   **解決方案**：
    ApexCharts 的 `resetSeries()` 對於單純的 X 軸縮放復原效果不佳。
    **正確實作方式**：
    ```javascript
    events: {
        dblclick: function (event, chartContext, config) {
            // 強制重置 X 軸的最大最小值為 undefined，觸發自動縮放計算
            chartContext.updateOptions({
                xaxis: { min: undefined, max: undefined }
            });
        }
    }
    ```

### C. 報表匯出功能 (Export Features)
優化了 `downloadExcel` 功能，提升使用者體驗。

*   **功能 1：另存新檔 (Save As Dialog)**
    使用 File System Access API 讓用戶選擇路徑。
    ```javascript
    if (window.showSaveFilePicker) {
        const handle = await window.showSaveFilePicker({ suggestedName: defaultName ... });
        // ... write code
    }
    ```
*   **功能 2：智能預設檔名**
    格式：`SPC_Report_[項目名稱]_[YYYYMMDD].xlsx`。
*   **功能 3：補全遺漏邏輯**
    確保留了 `Group Analysis` (群組分析) 的數據也能正確寫入 Excel。

---

## 4. 已解決的關鍵 Bug (Resolved Issues)
1.  **模穴圖表空白問題**：修復了 `renderCharts` 中重複且結構錯誤的 `else if` 區塊，導致代碼直接跳過繪圖邏輯的問題。
2.  **變量引用錯誤**：修正了 `displayResults` 中使用 `type` 而非 `data.type` 導致 Group 分析圖表無法顯示 HTML 容器的問題。
3.  **Zoom Reset 失效**：修正了使用 `resetSeries()` 無法完全重置 X-Axis Zoom 的問題。

---

## 5. 後續開發準則 (Guidelines for Future)
1.  **優先使用 SVG**：所有新圖表應優先使用 ApexCharts 實作，以確保高解析度輸出。
2.  **嚴格遵守配色**：修改圖表時，必須參照上述 **Section 3.A** 的配色標準，不可隨意使用 Lib 預設顏色。
3.  **保持操作一致性**：所有具備 Zoom 功能的圖表，都必須綁定雙擊重置事件 (Section 3.B)。
4.  **代碼整潔**：確保 `index.html` 不包含未使用的外部庫（如已移除的 Chart.js CDN）。
