# 開發失敗紀錄、原因分析與矯正措施 (Development Failure Record & Analysis)

本文件依據開發階段遭遇的技術困難、邏輯錯誤及系統限制進行分類紀錄，旨在避免未來新案重複發生類似錯誤。

## 1. 執行環境與指令類 (Environment & Commands)

### 1.1 PowerShell 鏈接指令失敗
*   **失敗現象**：使用 `git add . && git commit` 時報錯，提示 `&&` 不是有效的陳述式分隔符號。
*   **原因分析**：執行環境為 Windows PowerShell，而 `&&` 是 Linux/Unix Bash 或 CMD 的語法，PowerShell 預設不支援此符號進行命令鏈接。
*   **矯正措施**：改用分號 `;` 分隔命令，或將任務拆分為多個獨立的 `run_command` 呼叫。

### 1.2 自動化瀏覽器工具 (Subagent) 無法啟動
*   **失敗現象**：嘗試呼叫 `browser_subagent` 進行 UI 驗證時，回報 `$HOME environment variable is not set` 錯。
*   **原因分析**：系統環境缺乏必要的變數，導致 Playwright 底層無權限讀取或建立瀏覽器快取路徑。
*   **矯正措施**：轉向靜態分析，使用 `grep_search` 掃描 HTML/CSS/JS 內容，並透過 `view_file` 進行人工邏輯校對，取代實體瀏覽器渲染測試。

---

## 2. 邏輯實作與語法類 (Logic & Syntax)

### 2.1 JavaScript 類別閉合標記 (Braces) 偏移
*   **失敗現象**：在大規模重構 `processor.js` 後，出現 `Identifier expected` 或 `typeof is a reserved word` 錯誤。
*   **原因分析**：在取代多行程式碼塊時，誤刪了類別或函數的收尾花括號 `}`，導致類別定義提前結束，後續的方法變成了全域代碼（Invalid Global Scope）。
*   **矯正措施**：
    1.  實施修改前，使用 `view_file` 確保能看見完整的閉合區段。
    2.  對類別尾部實施「整體校驗」，確保 `class { ... }` 結構完整性。
    3.  使用 `multi_replace_file_content` 進行分區精確修改，而非單次覆蓋超長區域。

### 2.2 多檔案批號合併邏輯衝突
*   **失敗現象**：初始合併邏輯僅以「名稱」判斷，導致不同檔案中的 `Setup` 批次會被合併在一起，丟失獨立性。
*   **原因分析**：未考慮到「相同名稱可能來自不同物理檔案」的情境。
*   **矯正措施**：引入 `workbookId` (或檔案索引) 做為判斷維度。合併邏輯改為：`同檔案 + 基準名稱相同 = 合併`；`不同檔案 = 獨立保存`。

---

## 3. 輸出格式與相容性類 (Export & Compatibility)

### 3.1 Excel 座標位移導致工具解析失敗
*   **失敗現象**：為了追求「美觀」將產品資訊動態放在末尾，導致使用固定座標（如 B5/B6）讀取的舊有 VBA 工具無法抓取到產品名稱。
*   **原因分析**：開發者過於關注「動態排版」而忽略了「固定座標讀取」的系統相容性。
*   **矯正措施**：重構 `ExcelExporter` 矩陣，強制將 `ProductName` 固定在 A5/B5，`MeasurementUnit` 固定在 A6/B6。透過 AOA (Array of Arrays) 預先墊空行，確保這兩格與右側數據流共存而不位移。

### 3.2 數據中間空行導致資料斷層
*   **失敗現象**：初始為了隔離標頭與數據，在中間插入了空行，導致自動化分析軟體在讀取時判定為「資料結束」。
*   **原因分析**：對資料匯入端（Import Engine）的「連續性檢查」機制瞭解不足。
*   **矯正措施**：移除所有人工插入的空行。數據流、批號、規格標籤應從 Row 2 開始緊密依序往下排列，規格僅保留首行記載。

---

## 4. UI/UX 視覺感知類 (Aesthetics)

### 4.1 垂直批號字體比重失調
*   **失敗現象**：批號旋轉 180 度且使用 14px 粗體，在窄螢幕下會強烈擠壓量測數值的可視區域。
*   **原因分析**：垂直字體 (Vertical-rl) 在視覺上的高度遠大於寬度，大字體會導致工作表變得異常「細長」。
*   **矯正措施**：與使用者確認後，將字體縮小至 **12px** 並微調字距 (`letter-spacing: 0.5px`)，在可讀性與排版密度間取得平衡。

---

## 總結與矯正機制 (Summary)
後續開發應遵循：
1. **先複述、再修改**：涉及介面座標或數據結構變動時，必須先向使用者覆核邏輯描述。
2. **小步快跑**：避免單次修改超過 500 行代碼，降低括號閉合錯誤的風險。
3. **固定座標優先**：凡涉及 Excel 資料交換，固定座標（Fixed Location）的優先級高於動態排版。
